<!DOCTYPE html>
<html>
<head>
  <title>Choose Username</title>
  <style>
    body {
      font-family: sans-serif;
      background: #ffeef3;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .box {
      background: white;
      padding: 25px;
      border-radius: 14px;
      width: 320px;
      text-align: center;
    }
    input {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
    }
    button {
      margin-top: 15px;
      width: 100%;
      padding: 12px;
      background: #ff5c8d;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>Pick a username ðŸ’–</h2>
  <p>This will be your public link</p>

  <input id="username" placeholder="e.g. prashant" />
  <button onclick="saveUsername()">Continue</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    doc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ðŸ”¥ Firebase config (use your existing one)
  const firebaseConfig = {
    apiKey: "AIzaSyCviJWlQvukpfikmHOG-GoAvAnzTBRt8OI",
    authDomain: "cutie-feedback.firebaseapp.com",
    projectId: "cutie-feedback"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const input = document.getElementById("username");
  const btn = document.getElementById("continueBtn");
  const status = document.getElementById("status");

  // ðŸ”½ Force lowercase while typing
  input.addEventListener("input", () => {
    input.value = input.value.toLowerCase();
  });

  btn.addEventListener("click", async () => {
    const username = input.value.trim().toLowerCase();

    if (!username) {
      status.innerText = "Username required";
      return;
    }

    if (!/^[a-z0-9_]{3,20}$/.test(username)) {
      status.innerText = "Only aâ€“z, 0â€“9, _ (3â€“20 chars)";
      return;
    }

    const user = auth.currentUser;
    if (!user) {
      status.innerText = "Please login first";
      return;
    }

    try {
      await setDoc(doc(db, "usernames", username), {
        uid: user.uid,
        createdAt: Date.now()
      });

      // âœ… Redirect after success
      window.location.href = "dashboard.html";
    } catch (e) {
      status.innerText = "Username already taken";
    }
  });
</script>