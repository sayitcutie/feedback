<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
</head>
<body>

<h2 id="status">Checking login...</h2>

<h3>Your feedback link</h3>
<input id="bioLink" readonly style="width:100%" />
<button onclick="copy()">Copy link</button>

<h3>Messages</h3>
<div id="list">Loading feedbacks...</div>

<button onclick="logout()">Logout</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
      apiKey: "AIzaSyCviJWlQvukpfikmHOG-GoAvAnzTBRt8OI",
      authDomain: "cutie-feedback.firebaseapp.com",
      projectId: "cutie-feedback",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const status = document.getElementById("status");
const bioLinkInput = document.getElementById("bioLink");
const list = document.getElementById("list");

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.replace("login.html");
    return;
  }

  status.innerText = `Logged in as ${user.email}`;

  // âœ… CORRECT BIO LINK (IMPORTANT)
  const username = user.displayName || user.uid;
  const link =
    window.location.origin +
    "/feedback/u/" +
    username;

  bioLinkInput.value = link;

  loadFeedbacks(user.uid);
});

function loadFeedbacks(uid) {
  const q = query(
    collection(db, "feedbacks"),
    where("ownerUid", "==", uid),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snap) => {
    if (snap.empty) {
      list.innerText = "No feedback yet ðŸ¥²";
      return;
    }

    list.innerHTML = "";
    snap.forEach((doc) => {
      const d = doc.data();
      const p = document.createElement("p");
      p.innerText = d.text;
      list.appendChild(p);
    });
  });
}

window.copy = () => {
  navigator.clipboard.writeText(bioLinkInput.value);
  alert("Link copied ðŸ’–");
};

window.logout = () => {
  signOut(auth);
};
</script>

</body>
</html>