<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Feedbacks</title>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(#ffe9ef, #ffd6e3);
    }

    .top {
      background: linear-gradient(90deg, #ff5f9e, #ff87b7);
      padding: 16px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
    }

    .top button {
      background: rgba(255,255,255,0.25);
      border: none;
      padding: 8px 14px;
      border-radius: 20px;
      color: white;
      font-size: 14px;
    }

    .box {
      background: white;
      margin: 16px;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }

    h3 {
      margin-top: 0;
    }

    input {
      width: 100%;
  overflow-x: auto;
  white-space: nowrap;
  text-overflow: ellipsis;
    }

    .copyBtn {
      background: #ff5f9e;
      color: white;
      border: none;
      padding: 7px 14px;
      border-radius: 20px;
    }

    .message {
      background: #fff2f6;
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 8px;
    }
  </style>
</head>

<body>

  <!-- TOP BAR -->
  <div class="top">
    <div>Your Feedbacks ðŸ’Œ</div>
    <button id="logoutBtn">Logout</button>
  </div>

  <!-- STATUS -->
  <div class="box" id="statusBox">Checking login...</div>

  <!-- LINK -->
  <div class="box">
    <h3>Your feedback link</h3>
    <input id="bioLink" readonly />
<button id="copyBtn">Copy</button>

  <!-- MESSAGES -->
  <div class="box">
    <h3>Messages</h3>
    <div id="messagesBox">Loading feedbacks...</div>
  </div>
  
  <!-- âœ… SCRIPT MUST BE MODULE -->
   <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ðŸ”¥ Firebase config
    const firebaseConfig = {
  apiKey: "AIzaSyCviJWlQvukpfikmHOG-GoAvAnzTBRt8OI",
  authDomain: "cutie-feedback.firebaseapp.com",
  projectId: "cutie-feedback",
  storageBucket: "cutie-feedback.firebasestorage.app",
  messagingSenderId: "54683130068",
  appId: "1:54683130068:web:34ec8c608695668ab90341"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ðŸŽ¯ ELEMENTS */
const statusBox = document.getElementById("statusBox");
const feedbackLink = document.getElementById("feedbackLink");
const copyBtn = document.getElementById("copyBtn");
const messagesBox = document.getElementById("messagesBox");
const logoutBtn = document.getElementById("logoutBtn");

/* ðŸ” AUTH */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  /* ðŸ‘¤ GET USERNAME (CORRECT WAY) */
  const q = query(
    collection(db, "usernames"),
    where("uid", "==", user.uid)
  );

  const snap = await getDocs(q);

  if (snap.empty) {
    statusBox.innerText = "No username found";
    return;
  }

  const username = snap.docs[0].id; // ðŸ‘ˆ DOCUMENT ID = USERNAME

  /* âœ… SHOW STATUS */
  statusBox.innerText = `Logged in as ${username}`;

  /* ðŸ”— FEEDBACK LINK */
  const link =
    `https://sayitcutie.github.io/feedback/index.html?u=${username}`;
  feedbackLink.value = link;

  /* ðŸ“‹ COPY */
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(link);
    alert("Link copied ðŸ’–");
  };

  /* ðŸ’¬ LOAD MESSAGES */
  const mq = query(
    collection(db, "feedbacks"),
    where("ownerUid", "==", user.uid)
  );

  const msgs = await getDocs(mq);
  messagesBox.innerHTML = "";

  if (msgs.empty) {
    messagesBox.innerText = "No messages yet ðŸ’­";
    return;
  }

  msgs.forEach((doc) => {
    const div = document.createElement("div");
    div.className = "message";
    div.innerText = doc.data().text;
    messagesBox.appendChild(div);
  });
});

/* ðŸšª LOGOUT */
logoutBtn.onclick = async () => {
  await signOut(auth);
  window.location.href = "login.html";
};
</script>
  
</body>
</html>