<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Feedbacks</title>

  <!-- UI -->
  <link rel="stylesheet" href="dashboard-ui.css">
</head>
<body>

  <!-- TOP BAR -->
  <div class="top">
    <div>Your Feedbacks üíå</div>
    <button id="logoutBtn">Logout</button>
  </div>

  <!-- STATUS -->
  <div class="box" id="statusBox">
    Checking login...
  </div>

  <!-- LINK -->
  <div class="box">
    <h3>Your feedback link</h3>
    <input id="bioLink" readonly />
    <button id="copyBtn">Copy</button>
  </div>

  <!-- MESSAGES -->
  <div class="box">
    <h3>Messages</h3>
    <div id="messagesBox">Loading feedbacks...</div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // üî• Firebase config (yours is OK)
 const firebaseConfig = {
  apiKey: "AIzaSyCviJWlQvukpfikmHOG-GoAvAnzTBRt8OI",
  authDomain: "cutie-feedback.firebaseapp.com",
  projectId: "cutie-feedback",
  storageBucket: "cutie-feedback.firebasestorage.app",
  messagingSenderId: "54683130068",
  appId: "1:54683130068:web:34ec8c608695668ab90341"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ELEMENTS
  const statusBox = document.getElementById("statusBox");
  const messagesBox = document.getElementById("messagesBox");
  const bioLink = document.getElementById("bioLink");
  const logoutBtn = document.getElementById("logoutBtn");
  const copyBtn = document.getElementById("copyBtn");

  // LOGOUT
  logoutBtn.onclick = async () => {
    await signOut(auth);
    window.location.href = "login.html";
  };

  // COPY LINK
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(bioLink.value);
    copyBtn.innerText = "Copied!";
    setTimeout(() => copyBtn.innerText = "Copy", 1500);
  };

  // üîë AUTH CHECK
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {
    const q = query(
      collection(db, "usernames"),
      where("uid", "==", user.uid)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      // ‚ùó username not created yet
      window.location.href = "username.html";
      return;
    }

    // ‚úÖ username exists
    const username = snap.docs[0].id;

    // ‚úÖ STATUS
    document.getElementById("statusBox").innerText =
      `Logged in as ${user.email}`;

    // ‚úÖ BIO LINK (THIS WAS FAILING)
    bioLink.value =
     bioLink.value = `https://sayitcutie.github.io/feedback/index.html?u=${username}`;
    // ‚úÖ LOAD MESSAGES
    const msgQuery = query(
      collection(db, "messages"),
      where("to", "==", user.uid)
    );

    const msgs = await getDocs(msgQuery);
    messagesBox.innerHTML = "";

    if (msgs.empty) {
      messagesBox.innerHTML = "<p>No messages yet</p>";
    } else {
      msgs.forEach(doc => {
        messagesBox.innerHTML +=
          `<div class="message">${doc.data().text}</div>`;
      });
    }

  } catch (err) {
    document.getElementById("statusBox").innerText =
      "Error loading dashboard ‚ùå";
    console.error(err);
  }
});
</script>

</body>
</html>