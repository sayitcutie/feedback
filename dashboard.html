<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Your Feedbacks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
<h2 id="status">Checking loginâ€¦</h2>

<input id="bioLink" readonly />
<button onclick="copy()">Copy link</button>

<div id="list">Loading feedbacksâ€¦</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    setPersistence,
    browserLocalPersistence,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    orderBy,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCviJWlQvukpfikmHOG-GoAvAnzTBRt8OI",
  authDomain: "cutie-feedback.firebaseapp.com",
  projectId: " cutie-feedback",
  
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ðŸ” VERY IMPORTANT
  await setPersistence(auth, browserLocalPersistence);

  const status = document.getElementById("status");
  const list = document.getElementById("list");
  const bioLink = document.getElementById("bioLink");

  // âœ… SINGLE AUTH LISTENER â€” NOTHING ELSE
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.replace("login.html");
      return;
    }

    status.innerHTML = `Logged in as <b>${user.email}</b>`;

    // âœ… CORRECT LINK (MATCHES YOUR FOLDER)
    const link = `${location.origin}/Feedback/index.html?uid=${user.uid}`;
    bioLink.value = link;

    loadFeedbacks(user.uid);
  });

  function loadFeedbacks(uid) {
    const q = query(
      collection(db, "feedbacks"),
      where("ownerUid", "==", uid),
      orderBy("createdAt", "desc")
    );

    onSnapshot(q, (snap) => {
      if (snap.empty) {
        list.innerHTML = "No feedback yet ðŸ¥²";
        return;
      }

      list.innerHTML = "";
      snap.forEach(doc => {
        list.innerHTML += `<div>${doc.data().text}</div>`;
      });
    });
  }

  window.copy = () => {
    navigator.clipboard.writeText(bioLink.value);
    alert("Copied ðŸ’—");
  };

  window.logout = () => signOut(auth);
</script>
</body>
</html>