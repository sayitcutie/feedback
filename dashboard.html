<!DOCTYPE html>
<html>
<head>
  <title>Your Feedbacks ðŸ’Œ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>Your Feedbacks ðŸ’Œ</h1>
  <button id="logoutBtn">Logout</button>
</header>

<div class="container">

  <div class="card">
    <div id="userInfo" class="muted">Checking login...</div>
  </div>

  <div class="card">
    <h2>Your feedback link</h2>
    <input id="bioLink" readonly>
    <button class="copy-btn" id="copyBtn">Copy link</button>
  </div>

  <div class="card">
    <h2>Messages</h2>
    <div id="list" class="muted">Loading feedbacks...</div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCviJWlQvukpfikmHOG-GoAvAnzTBRt8OI",
  authDomain: "cutie-feedback.firebaseapp.com",
  projectId: " cutie-feedback",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userInfo = document.getElementById("userInfo");
const bioLink = document.getElementById("bioLink");
const list = document.getElementById("list");

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  userInfo.innerHTML = `Logged in as <strong>${user.email}</strong>`;

  const link =
    window.location.origin +
    "/feedback/?uid=" +
    user.uid;

  bioLink.value = link;

  document.getElementById("copyBtn").onclick = () => {
    navigator.clipboard.writeText(link);
    alert("Link copied ðŸ’–");
  };

  loadFeedbacks(user.uid);
});

function loadFeedbacks(uid) {
  const q = query(
    collection(db, "feedbacks"),
    where("ownerUid", "==", uid),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snap) => {
    list.innerHTML = "";
    if (snap.empty) {
      list.innerHTML = `<div class="muted">No feedback yet ðŸ¥²</div>`;
      return;
    }

    snap.forEach(doc => {
      const div = document.createElement("div");
      div.className = "message";
      div.textContent = doc.data().text;
      list.appendChild(div);
    });
  });
}

document.getElementById("logoutBtn").onclick = () => {
  signOut(auth);
};
</script>

</body>
</html>