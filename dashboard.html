<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Feedbacks</title>

  <!-- ONLY dashboard CSS -->
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="title">Your Feedbacks ðŸ’Œ</div>
    <button id="logoutBtn" class="logout">Logout</button>
  </header>

  <!-- MAIN WRAP -->
  <div class="wrap">

    <!-- USER INFO -->
    <div class="card user" id="userInfo">
      Checking login...
    </div>

    <!-- BIO LINK -->
    <div class="card">
      <h3>Your feedback link</h3>
      <div class="link-row">
        <input id="bioLink" readonly />
        <button id="copyBtn" class="btn">Copy link</button>
      </div>
    </div>

    <!-- MESSAGES -->
    <div class="card">
      <h3>Messages</h3>
      <div id="list" class="messages">
        Loading feedbacks...
      </div>
    </div>

  </div>

  <!-- FIREBASE LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCviJWlQvukpfikmHOG-GoAvAnzTBRt8OI",
      authDomain: "cutie-feedback.firebaseapp.com",
      projectId: "cutie-feedback"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userInfo = document.getElementById("userInfo");
    const bioLink = document.getElementById("bioLink");
    const list = document.getElementById("list");

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      userInfo.innerHTML = `Logged in as <strong>${user.email}</strong>`;

      const link =
        "https://sayitcutie.github.io/feedback/index.html?uid=" +
        user.uid;

      bioLink.value = link;

      document.getElementById("copyBtn").onclick = () => {
        navigator.clipboard.writeText(link);
        alert("Link copied ðŸ’–");
      };

      loadFeedbacks(user.uid);
    });

    function loadFeedbacks(uid) {
      const q = query(
        collection(db, "feedbacks"),
        where("ownerUid", "==", uid),
        orderBy("createdAt", "desc")
      );

      onSnapshot(q, (snap) => {
        list.innerHTML = "";

        if (snap.empty) {
          list.innerHTML = `<div class="muted">No feedback yet ðŸ¥º</div>`;
          return;
        }

        snap.forEach((doc) => {
          const div = document.createElement("div");
          div.className = "message";
          div.textContent = doc.data().text;
          list.appendChild(div);
        });
      });
    }

    document.getElementById("logoutBtn").onclick = () => {
      signOut(auth);
    };
  </script>

</body>
</html>